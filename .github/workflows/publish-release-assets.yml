name: Publish Release Binaries

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  publish-cli:
    name: Build CLI (${{ matrix.runtime }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            runtime: linux-x64
          - os: windows-latest
            runtime: win-x64
          - os: macos-latest
            runtime: osx-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore DocxportNet.sln

      - name: Publish CLI
        run: dotnet publish DocxportNet.Cli/DocxportNet.Cli.csproj --configuration Release -r ${{ matrix.runtime }} --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true -o artifacts/cli/${{ matrix.runtime }}

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        id: archive-unix
        shell: bash
        run: |
          ARCHIVE="docxport-cli-${{ matrix.runtime }}.zip"
          cd artifacts/cli/${{ matrix.runtime }}
          zip -r "../../${ARCHIVE}" .
          echo "path=${{ github.workspace }}/artifacts/${ARCHIVE}" >> "$GITHUB_OUTPUT"

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        id: archive-win
        shell: pwsh
        run: |
          $archive = "docxport-cli-${{ matrix.runtime }}.zip"
          $source = "artifacts/cli/${{ matrix.runtime }}"
          Compress-Archive -Path "$source\*" -DestinationPath "artifacts\$archive"
          "path=${{ github.workspace }}\artifacts\$archive" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docxport-cli-${{ matrix.runtime }}
          path: ${{ coalesce(steps.archive-unix.outputs.path, steps.archive-win.outputs.path) }}

      - name: Attach to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ coalesce(steps.archive-unix.outputs.path, steps.archive-win.outputs.path) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
